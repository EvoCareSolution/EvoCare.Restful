@{
    ViewData["Title"] = "Reminder Types";
}

<section class="card">
    <div class="card-header">
        <div>
            <p class="text-muted mb-1 small">Reusable templates</p>
            <h1 class="h4 mb-0">Reminder Types</h1>
        </div>
        <div class="d-flex gap-2 flex-wrap">
            <button type="button" class="btn btn-outline" id="btnRefreshTypes">Refresh</button>
            <button type="button" class="btn btn-primary" id="btnAddReminderType">New reminder type</button>
        </div>
    </div>
    <div id="alertPlaceholder"></div>
    <div class="reminder-grid" id="reminderTypeGrid">
        <div class="card empty-state mb-0">Loading reminder types...</div>
    </div>
</section>

<div class="modal fade" id="reminderTypeModal" tabindex="-1" aria-labelledby="reminderTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reminderTypeModalLabel">Reminder Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="reminderTypeId" value="0" />
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="typeNameInput">Type Name</label>
                        <input class="form-control" id="typeNameInput" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="descriptionInput">Description</label>
                        <input class="form-control" id="descriptionInput" />
                    </div>
                    <div class="col-md-4">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="isRecurringInput" />
                            <label class="form-check-label" for="isRecurringInput">Recurring</label>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="intervalDaysInput">Interval Days</label>
                        <input class="form-control" type="number" id="intervalDaysInput" min="0" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label" for="intervalKmInput">Interval Km</label>
                        <input class="form-control" type="number" id="intervalKmInput" min="0" />
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="isPaymentRelatedInput" />
                            <label class="form-check-label" for="isPaymentRelatedInput">Payment Related</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check form-switch mt-4">
                            <input class="form-check-input" type="checkbox" id="isActiveInput" checked />
                            <label class="form-check-label" for="isActiveInput">Active</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveReminderTypeBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reminderTypeDetailModal" tabindex="-1" aria-labelledby="reminderTypeDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reminderTypeDetailLabel">Reminder Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <tbody>
                        <tr>
                            <th>Name</th>
                            <td id="detailTypeName"></td>
                        </tr>
                        <tr>
                            <th>Description</th>
                            <td id="detailDescription"></td>
                        </tr>
                        <tr>
                            <th>Recurring</th>
                            <td id="detailRecurring"></td>
                        </tr>
                        <tr>
                            <th>Interval Days</th>
                            <td id="detailIntervalDays"></td>
                        </tr>
                        <tr>
                            <th>Interval Km</th>
                            <td id="detailIntervalKm"></td>
                        </tr>
                        <tr>
                            <th>Payment Related</th>
                            <td id="detailPaymentRelated"></td>
                        </tr>
                        <tr>
                            <th>Active</th>
                            <td id="detailIsActive"></td>
                        </tr>
                        <tr>
                            <th>Created</th>
                            <td id="detailCreatedDate"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteLabel">Delete reminder type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this reminder type?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function ($) {
            const apiBaseUrl = 'https://localhost:7114/api/ReminderTypeKhiemNvd';
            const $grid = $('#reminderTypeGrid');
            const $alert = $('#alertPlaceholder');
            const reminderTypeModal = new bootstrap.Modal(document.getElementById('reminderTypeModal'));
            const detailModal = new bootstrap.Modal(document.getElementById('reminderTypeDetailModal'));
            const confirmDeleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            let pendingDeleteId = null;

            $(document).ready(function () {
                loadReminderTypes();
                $('#btnRefreshTypes').on('click', loadReminderTypes);
                $('#btnAddReminderType').on('click', () => openEditModal());
                $('#saveReminderTypeBtn').on('click', saveReminderType);
                $('#isRecurringInput').on('change', toggleIntervalFields);
                $('#confirmDeleteBtn').on('click', deleteReminderType);
            });

            function loadReminderTypes() {
                setRowsMessage('Loading reminder types...');
                $.ajax({
                    url: apiBaseUrl,
                    type: 'GET',
                    headers: buildHeaders(),
                    success: function (data) {
                        if (!Array.isArray(data) || data.length === 0) {
                            setRowsMessage('No reminder types available.');
                            return;
                        }

                        const cards = data.map((item) => `
                            <article class="card reminder-card">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <p class="text-muted small mb-1">${formatDate(item.createdDate)}</p>
                                        <h3>${htmlEncode(item.typeName)}</h3>
                                        <p class="text-muted mb-2">${htmlEncode(item.description ?? '') || 'No description'}</p>
                                    </div>
                                    <span class="pill ${item.isActive ? 'pill-success' : 'pill-muted'}">${item.isActive ? 'Active' : 'Inactive'}</span>
                                </div>
                                <div class="reminder-meta">
                                    <div>
                                        <span>Recurring</span>
                                        <strong>${item.isRecurring ? 'Yes' : 'No'}</strong>
                                    </div>
                                    <div>
                                        <span>Interval days</span>
                                        <strong>${item.intervalDays ?? '-'}</strong>
                                    </div>
                                    <div>
                                        <span>Interval km</span>
                                        <strong>${item.intervalKm ?? '-'}</strong>
                                    </div>
                                    <div>
                                        <span>Payment related</span>
                                        <strong>${item.isPaymentRelated ? 'Yes' : 'No'}</strong>
                                    </div>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mt-2">
                                    <button class="btn btn-ghost" onclick="viewReminderType(${item.reminderTypeKhiemNvdid})">View</button>
                                    <button class="btn btn-outline" onclick="editReminderType(${item.reminderTypeKhiemNvdid})">Edit</button>
                                    <button class="btn btn-outline text-danger" onclick="promptDeleteReminderType(${item.reminderTypeKhiemNvdid})">Delete</button>
                                </div>
                            </article>
                        `);

                        $grid.html(cards.join(''));
                    },
                    error: function (xhr) {
                        showAlert('Unable to load reminder types. ' + xhr.statusText);
                        setRowsMessage('Failed to load reminder types.');
                    }
                });
            }

            function buildHeaders() {
                const headers = {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json; charset=utf-8'
                };
                const token = getToken();
                if (token) {
                    headers['Authorization'] = 'Bearer ' + token;
                }

                return headers;
            }

            function openEditModal(data) {
                $('#reminderTypeModalLabel').text(data ? 'Edit Reminder Type' : 'New Reminder Type');
                $('#reminderTypeId').val(data?.reminderTypeKhiemNvdid ?? 0);
                $('#typeNameInput').val(data?.typeName ?? '');
                $('#descriptionInput').val(data?.description ?? '');
                $('#isRecurringInput').prop('checked', data?.isRecurring ?? false);
                $('#intervalDaysInput').val(data?.intervalDays ?? '');
                $('#intervalKmInput').val(data?.intervalKm ?? '');
                $('#isPaymentRelatedInput').prop('checked', data?.isPaymentRelated ?? false);
                $('#isActiveInput').prop('checked', data?.isActive ?? true);
                toggleIntervalFields();
                reminderTypeModal.show();
            }

            function saveReminderType() {
                const id = Number($('#reminderTypeId').val());
                const isRecurring = $('#isRecurringInput').is(':checked');
                const payload = {
                    reminderTypeKhiemNvdid: id,
                    typeName: $('#typeNameInput').val(),
                    description: $('#descriptionInput').val(),
                    isRecurring: isRecurring,
                    intervalDays: isRecurring ? parseNullableInt($('#intervalDaysInput').val()) : null,
                    intervalKm: isRecurring ? parseNullableInt($('#intervalKmInput').val()) : null,
                    isPaymentRelated: $('#isPaymentRelatedInput').is(':checked'),
                    isActive: $('#isActiveInput').is(':checked')
                };

                if (!payload.typeName) {
                    showAlert('Type name is required.');
                    return;
                }

                const method = id && id > 0 ? 'PUT' : 'POST';

                $.ajax({
                    url: apiBaseUrl,
                    type: method,
                    headers: buildHeaders(),
                    data: JSON.stringify(payload),
                    success: function () {
                        reminderTypeModal.hide();
                        loadReminderTypes();
                        showAlert('Reminder type saved successfully.', 'success');
                    },
                    error: function (xhr) {
                        showAlert('Unable to save reminder type. ' + xhr.statusText);
                    }
                });
            }

            function viewReminderType(id) {
                $.ajax({
                    url: apiBaseUrl + '/' + id,
                    type: 'GET',
                    headers: buildHeaders(),
                    success: function (item) {
                        $('#detailTypeName').text(item.typeName);
                        $('#detailDescription').text(item.description ?? '-');
                        $('#detailRecurring').text(item.isRecurring ? 'Yes' : 'No');
                        $('#detailIntervalDays').text(item.intervalDays ?? '-');
                        $('#detailIntervalKm').text(item.intervalKm ?? '-');
                        $('#detailPaymentRelated').text(item.isPaymentRelated ? 'Yes' : 'No');
                        $('#detailIsActive').text(item.isActive ? 'Active' : 'Inactive');
                        $('#detailCreatedDate').text(formatDate(item.createdDate));
                        detailModal.show();
                    },
                    error: function (xhr) {
                        showAlert('Unable to load reminder type details. ' + xhr.statusText);
                    }
                });
            }

            function editReminderType(id) {
                $.ajax({
                    url: apiBaseUrl + '/' + id,
                    type: 'GET',
                    headers: buildHeaders(),
                    success: function (item) {
                        openEditModal(item);
                    },
                    error: function (xhr) {
                        showAlert('Unable to load reminder type. ' + xhr.statusText);
                    }
                });
            }

            function promptDeleteReminderType(id) {
                pendingDeleteId = id;
                confirmDeleteModal.show();
            }

            function deleteReminderType() {
                if (!pendingDeleteId) {
                    confirmDeleteModal.hide();
                    return;
                }

                $.ajax({
                    url: apiBaseUrl + '/' + pendingDeleteId,
                    type: 'DELETE',
                    headers: buildHeaders(),
                    success: function () {
                        showAlert('Reminder type deleted.', 'success');
                        loadReminderTypes();
                    },
                    error: function (xhr) {
                        showAlert('Unable to delete reminder type. ' + xhr.statusText);
                    },
                    complete: function () {
                        pendingDeleteId = null;
                        confirmDeleteModal.hide();
                    }
                });
            }

            function toggleIntervalFields() {
                const isChecked = $('#isRecurringInput').is(':checked');
                $('#intervalDaysInput, #intervalKmInput').prop('disabled', !isChecked);
            }

            function setRowsMessage(message) {
                $grid.html(`<div class="card empty-state mb-0">${message}</div>`);
            }

            function showAlert(message, type = 'danger') {
                const alertId = 'alert-' + Date.now();
                const alertHtml = `
                    <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`;
                $alert.html(alertHtml);
                setTimeout(() => $('#' + alertId).alert('close'), 5000);
            }

            function formatDate(value) {
                if (!value) {
                    return '-';
                }
                const date = new Date(value);
                return isNaN(date.getTime()) ? '-' : date.toLocaleDateString();
            }

            function parseNullableInt(val) {
                const parsed = parseInt(val, 10);
                return isNaN(parsed) ? null : parsed;
            }

            function htmlEncode(value) {
                return $('<div/>').text(value ?? '').html();
            }

            function getToken() {
                const tokenEntry = document.cookie.split(';').map(c => c.trim()).find(c => c.startsWith('TokenString='));
                return tokenEntry ? decodeURIComponent(tokenEntry.split('=')[1]) : '';
            }

            window.viewReminderType = viewReminderType;
            window.editReminderType = editReminderType;
            window.promptDeleteReminderType = promptDeleteReminderType;

        })(jQuery);
    </script>
}
